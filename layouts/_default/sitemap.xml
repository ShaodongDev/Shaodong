{{- $pages := where .Site.Pages "Draft" "ne" true -}}
{{- $pages = where $pages "Params.robots" "ne" "noindex,nofollow" -}}
{{- $pages = where $pages "Params.robots" "ne" "noindex" -}}
{{- $pages = where $pages "Kind" "ne" "404" -}}
{{- $pages = where $pages "Kind" "ne" "robotsTXT" -}}
{{- $pages = where $pages "Kind" "ne" "sitemap" -}}
{{- $pages = where $pages "Kind" "ne" "RSS" -}}
{{- $pages = where $pages "Kind" "ne" "taxonomy" -}}
{{- $pages = where $pages "Kind" "ne" "taxonomyTerm" -}}
{{- $pages = where $pages "Params.noindex" "ne" true -}}
{{- $pages = sort $pages "Lastmod" "desc" -}}
{{- printf "<?xml version=\"1.0\" encoding=\"UTF-8\"?>" | safeHTML }}
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
  {{- range $pages }}
  <url>
    <loc>{{ .Permalink }}</loc>
    {{- $lastMod := .Lastmod -}}
    {{- if $lastMod.IsZero -}}
      {{- if .PublishDate.IsZero -}}
        {{- if .Date.IsZero -}}
          {{- $lastMod = now -}}
        {{- else -}}
          {{- $lastMod = .Date -}}
        {{- end -}}
      {{- else -}}
        {{- $lastMod = .PublishDate -}}
      {{- end -}}
    {{- end -}}
    <lastmod>{{ $lastMod.Format "2006-01-02T15:04:05Z07:00" }}</lastmod>
    {{- $scratch := newScratch -}}
    {{- $scratch.Set "freq" "monthly" -}}
    {{- with .Site.Sitemap }}
      {{- with .ChangeFreq }}
        {{- $scratch.Set "freq" . -}}
      {{- end -}}
    {{- end -}}
    {{- with .Sitemap }}
      {{- with .ChangeFreq }}
        {{- $scratch.Set "freq" . -}}
      {{- end -}}
    {{- end -}}
    <changefreq>{{ $scratch.Get "freq" }}</changefreq>
    {{- $scratch.Set "priority" 0.5 -}}
    {{- with .Site.Sitemap }}
      {{- with .Priority }}
        {{- $scratch.Set "priority" . -}}
      {{- end -}}
    {{- end -}}
    {{- with .Sitemap }}
      {{- with .Priority }}
        {{- $scratch.Set "priority" . -}}
      {{- end -}}
    {{- end -}}
    <priority>{{ printf "%.1f" ($scratch.Get "priority") }}</priority>
  </url>
  {{- end }}
</urlset>
